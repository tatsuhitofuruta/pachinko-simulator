<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒ´ã‚¡ ãƒ‘ãƒãƒ³ã‚³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .controls {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .control-group {
            flex: 1;
            min-width: 120px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 14px;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.15);
            color: #fff;
            font-size: 16px;
        }
        select option {
            background: #1a1a2e;
        }
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-start {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }
        .btn-start:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }
        .btn-start:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        .display {
            background: #000;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status-line {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #0f0;
            margin-bottom: 10px;
        }
        .rotation-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            color: #fff;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
        }
        .rotation-label {
            text-align: center;
            color: #888;
            margin-top: 5px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .stat-box {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
        }
        .profit-plus { color: #4ecdc4; }
        .profit-minus { color: #ff6b6b; }
        .log {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .log-hit {
            color: #ffd93d;
            font-weight: bold;
        }
        .log-st {
            color: #ff6b6b;
        }
        .log-chain {
            color: #4ecdc4;
            padding-left: 20px;
        }
        .log-jitan {
            color: #a855f7;
        }
        .log-charge {
            color: #f59e0b;
        }
        .state-normal { color: #4ecdc4; }
        .state-st { color: #ff6b6b; }
        .state-jitan { color: #a855f7; }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .speed-control input[type="range"] {
            flex: 1;
        }
        .cumulative-stats {
            background: linear-gradient(135deg, #1e3a5f, #0d1b2a);
            border: 2px solid #4ecdc4;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .cumulative-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #4ecdc4;
        }
        .btn-reset {
            background: rgba(255,255,255,0.1);
            border: 1px solid #666;
            color: #888;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-reset:hover {
            background: rgba(255,100,100,0.2);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        .cumulative-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .cumulative-item {
            text-align: center;
        }
        .cumulative-value {
            font-size: 18px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        .cumulative-label {
            font-size: 11px;
            color: #888;
            margin-top: 3px;
        }
        .cum-plus { color: #4ecdc4; }
        .cum-minus { color: #ff6b6b; }
        .stats-panels {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stats-panels .cumulative-stats {
            flex: 1;
            margin-bottom: 0;
        }
        .ranking-panel {
            flex: 1;
            background: linear-gradient(135deg, #3d2a1e, #1a1a2e);
            border: 2px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
        }
        .ranking-panel .cumulative-header {
            color: #f59e0b;
        }
        .ranking-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .ranking-item {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
        }
        .ranking-item.best {
            border-left: 3px solid #4ecdc4;
        }
        .ranking-item.worst {
            border-left: 3px solid #ff6b6b;
        }
        .ranking-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }
        .ranking-value {
            font-size: 16px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #f59e0b;
        }
        .ranking-item.best .ranking-value { color: #4ecdc4; }
        .ranking-item.worst .ranking-value { color: #ff6b6b; }
        @media (max-width: 600px) {
            .stats-panels {
                flex-direction: column;
            }
            .cumulative-grid, .ranking-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .final-result {
            background: linear-gradient(135deg, #2d2d44, #1a1a2e);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            display: none;
        }
        .final-result h2 {
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        .final-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .final-stat {
            padding: 10px;
        }
        .final-stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        .final-stat-label {
            color: #888;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ° ãƒ‘ãƒãƒ³ã‚³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        <p class="subtitle">ãƒªã‚¢ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰</p>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>æ©Ÿç¨®</label>
                    <select id="machine">
                        <option value="eva15">æ±ç”¨äººå‹æ±ºæˆ¦å…µå™¨15</option>
                        <option value="eva17">æ±ç”¨äººå‹æ±ºæˆ¦å…µå™¨17</option>
                        <option value="garo12">é»„é‡‘é¨å£«12</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ç·å›è»¢æ•°</label>
                    <select id="totalSpins">
                        <option value="500">500å›è»¢</option>
                        <option value="1000">1000å›è»¢</option>
                        <option value="2000" selected>2000å›è»¢</option>
                        <option value="3000">3000å›è»¢</option>
                    </select>
                </div>
            </div>
            <div class="control-row">
                <div class="control-group">
                    <label>åƒå††å›è»¢æ•°</label>
                    <select id="rotation1k">
                        <option value="16">16å›è»¢</option>
                        <option value="17">17å›è»¢</option>
                        <option value="18" selected>18å›è»¢</option>
                        <option value="19">19å›è»¢</option>
                        <option value="20">20å›è»¢</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>é€Ÿåº¦</label>
                    <div class="speed-control">
                        <input type="range" id="speed" min="1" max="10" value="5">
                        <span id="speedLabel">5</span>
                    </div>
                </div>
            </div>
            <button class="btn btn-start" id="startBtn" onclick="startSimulation()">
                ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            </button>
        </div>

        <div class="display">
            <div class="rotation-display" id="rotationDisplay">0</div>
            <div class="rotation-label">å›è»¢</div>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="ballsDisplay">0</div>
                    <div class="stat-label">æŒã¡ç‰</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="investDisplay">0</div>
                    <div class="stat-label">æŠ•è³‡(å††)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value profit-minus" id="profitDisplay">0</div>
                    <div class="stat-label">åæ”¯(å††)</div>
                </div>
            </div>
            <div class="status-line">
                çŠ¶æ…‹: <span id="stateDisplay" class="state-normal">å¾…æ©Ÿä¸­</span>
            </div>
        </div>

        <div class="log" id="log"></div>

        <!-- ç´¯è¨ˆåæ”¯ & ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ãƒãƒ« -->
        <div class="stats-panels">
            <div class="cumulative-stats">
                <div class="cumulative-header">
                    <span>ğŸ“Š ç´¯è¨ˆåæ”¯</span>
                    <button class="btn-reset" onclick="resetCumulativeStats()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            <div class="cumulative-grid">
                <div class="cumulative-item">
                    <div class="cumulative-value" id="cumSessions">0</div>
                    <div class="cumulative-label">ç¨¼åƒå›æ•°</div>
                </div>
                <div class="cumulative-item">
                    <div class="cumulative-value" id="cumInvest">0</div>
                    <div class="cumulative-label">ç´¯è¨ˆæŠ•è³‡</div>
                </div>
                <div class="cumulative-item">
                    <div class="cumulative-value" id="cumPayout">0</div>
                    <div class="cumulative-label">ç´¯è¨ˆå‡ºç‰</div>
                </div>
                <div class="cumulative-item">
                    <div class="cumulative-value" id="cumProfit">Â±0</div>
                    <div class="cumulative-label">ç´¯è¨ˆåæ”¯</div>
                </div>
            </div>
            </div>

            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ãƒãƒ« -->
            <div class="ranking-panel">
                <div class="cumulative-header">
                    <span>ğŸ† å€‹äººè¨˜éŒ²</span>
                    <button class="btn-reset" onclick="resetRankingStats()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
                <div class="ranking-grid">
                    <div class="ranking-item best">
                        <div class="ranking-label">æœ€é«˜åæ”¯</div>
                        <div class="ranking-value" id="rankBestProfit">---</div>
                    </div>
                    <div class="ranking-item worst">
                        <div class="ranking-label">æœ€ä½åæ”¯</div>
                        <div class="ranking-value" id="rankWorstProfit">---</div>
                    </div>
                    <div class="ranking-item">
                        <div class="ranking-label">æœ€å¤§é€£ãƒãƒ£ãƒ³</div>
                        <div class="ranking-value" id="rankMaxChain">---</div>
                    </div>
                    <div class="ranking-item">
                        <div class="ranking-label">ä¸€æ’ƒæœ€é«˜å‡ºç‰</div>
                        <div class="ranking-value" id="rankMaxPayout">---</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="final-result" id="finalResult">
            <h2>ğŸ° æœ€çµ‚çµæœ</h2>
            <div class="final-stats">
                <div class="final-stat">
                    <div class="final-stat-value" id="finalSpins">0</div>
                    <div class="final-stat-label">ç·å›è»¢æ•°</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalHits">0</div>
                    <div class="final-stat-label">ç·å½“ãŸã‚Š</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalBalls">0</div>
                    <div class="final-stat-label">æŒã¡ç‰</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalProfit">0</div>
                    <div class="final-stat-label">åæ”¯</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ©Ÿç¨®ã‚¹ãƒšãƒƒã‚¯
        const SPECS = {
            eva15: {
                name: "æ±ç”¨äººå‹æ±ºæˆ¦å…µå™¨15",
                hitProb: 1 / 319.7,
                stHitProb: 1 / 99.4,
                hesoPayouts: [
                    { prob: 0.03, payout: 1400, st: true },
                    { prob: 0.56, payout: 420, st: true },
                    { prob: 0.41, payout: 420, st: false }
                ],
                denchuPayout: 1400,
                stSpins: 163,
                jitanSpins: 100,
                jitanRotation1k: 30,
                zanhoCount: 4,
                chargeProb: 0,
                chargePayout: 0,
                chargeStRate: 0,
                isLT: false,
                ltEndPayout: 0,
                stContinueRate: 0.807
            },
            eva17: {
                name: "æ±ç”¨äººå‹æ±ºæˆ¦å…µå™¨17",
                hitProb: 1 / 399.9,
                stHitProb: 1 / 99.6,
                hesoPayouts: [
                    { prob: 0.005, payout: 1400, st: true },
                    { prob: 0.495, payout: 280, st: false },
                    { prob: 0.50, payout: 280, st: true }
                ],
                denchuPayout: 2240,
                stSpins: 157,
                jitanSpins: 100,
                jitanRotation1k: 30,
                zanhoCount: 0,
                chargeProb: 1 / 2750.9,
                chargePayout: 280,
                chargeStRate: 0.02,
                isLT: false,
                ltEndPayout: 0,
                stContinueRate: 0.795
            },
            garo12: {
                name: "é»„é‡‘é¨å£«12",
                hitProb: 1 / 437.49,
                stHitProb: 1.0,
                hesoPayouts: [
                    { prob: 0.50, payout: 1400, st: true },
                    { prob: 0.50, payout: 1400, st: false }
                ],
                denchuPayout: 0,  // æŒ¯ã‚Šåˆ†ã‘ã‚ã‚Šã®å ´åˆã¯ä½¿ç”¨ã—ãªã„
                denchuPayouts: [
                    { prob: 0.329, payout: 7000 },  // ç¶™ç¶šæ™‚ç´„33%ã§7000ç™º
                    { prob: 0.671, payout: 1400 }   // ç¶™ç¶šæ™‚ç´„67%ã§1400ç™º
                ],
                stSpins: 1,
                jitanSpins: 0,
                jitanRotation1k: 30,
                zanhoCount: 0,
                chargeProb: 0,
                chargePayout: 0,
                chargeStRate: 0,
                isLT: true,
                ltChallengeRate: 0.50,  // LTãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸç‡50%
                ltFirstPayout: 7000,    // LTçªå…¥æ™‚7000ç™ºå›ºå®š
                ltEndPayout: 1400,      // LTè»¢è½æ™‚1400ç™º
                stContinueRate: 0.76    // LTç¶™ç¶šç‡76%
            }
        };

        let isRunning = false;
        let shouldStop = false;

        // ========================================
        // ç´¯è¨ˆåæ”¯ç®¡ç†ï¼ˆlocalStorageï¼‰
        // ========================================
        const STORAGE_KEY = 'pachinko_cumulative_stats';

        function loadCumulativeStats() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                return JSON.parse(data);
            }
            return { sessions: 0, invest: 0, payout: 0 };
        }

        function saveCumulativeStats(stats) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
        }

        function updateCumulativeDisplay() {
            const stats = loadCumulativeStats();
            const profit = Math.floor(stats.payout * 4) - stats.invest;  // ç­‰ä¾¡æ›ç®—

            document.getElementById('cumSessions').textContent = stats.sessions;
            document.getElementById('cumInvest').textContent = stats.invest.toLocaleString() + 'å††';
            document.getElementById('cumPayout').textContent = stats.payout.toLocaleString() + 'ç™º';

            const profitEl = document.getElementById('cumProfit');
            if (profit >= 0) {
                profitEl.textContent = '+' + profit.toLocaleString() + 'å††';
                profitEl.className = 'cumulative-value cum-plus';
            } else {
                profitEl.textContent = profit.toLocaleString() + 'å††';
                profitEl.className = 'cumulative-value cum-minus';
            }
        }

        function addSessionResult(invest, payout) {
            const stats = loadCumulativeStats();
            stats.sessions++;
            stats.invest += invest;
            stats.payout += payout;
            saveCumulativeStats(stats);
            updateCumulativeDisplay();
        }

        function resetCumulativeStats() {
            if (confirm('ç´¯è¨ˆåæ”¯ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem(STORAGE_KEY);
                updateCumulativeDisplay();
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç´¯è¨ˆè¡¨ç¤ºã‚’æ›´æ–°
        document.addEventListener('DOMContentLoaded', updateCumulativeDisplay);

        // ========================================
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç®¡ç†ï¼ˆlocalStorageï¼‰
        // ========================================
        const RANKING_KEY = 'pachinko_ranking_stats';

        function loadRankingStats() {
            const data = localStorage.getItem(RANKING_KEY);
            if (data) {
                return JSON.parse(data);
            }
            return {
                bestProfit: null,
                worstProfit: null,
                maxChain: null,
                maxPayout: null
            };
        }

        function saveRankingStats(stats) {
            localStorage.setItem(RANKING_KEY, JSON.stringify(stats));
        }

        function updateRankingDisplay() {
            const stats = loadRankingStats();

            const bestEl = document.getElementById('rankBestProfit');
            const worstEl = document.getElementById('rankWorstProfit');
            const chainEl = document.getElementById('rankMaxChain');
            const payoutEl = document.getElementById('rankMaxPayout');

            bestEl.textContent = stats.bestProfit !== null
                ? '+' + stats.bestProfit.toLocaleString() + 'å††' : '---';
            worstEl.textContent = stats.worstProfit !== null
                ? stats.worstProfit.toLocaleString() + 'å††' : '---';
            chainEl.textContent = stats.maxChain !== null
                ? stats.maxChain + 'é€£' : '---';
            payoutEl.textContent = stats.maxPayout !== null
                ? stats.maxPayout.toLocaleString() + 'ç™º' : '---';
        }

        function updateRankingWithResult(profit, maxChain, totalPayout) {
            const stats = loadRankingStats();
            let updated = false;

            // æœ€é«˜åæ”¯ï¼ˆãƒ—ãƒ©ã‚¹ã®è¨˜éŒ²ã®ã¿ï¼‰
            if (profit > 0 && (stats.bestProfit === null || profit > stats.bestProfit)) {
                stats.bestProfit = profit;
                updated = true;
            }

            // æœ€ä½åæ”¯ï¼ˆãƒã‚¤ãƒŠã‚¹ã®è¨˜éŒ²ã®ã¿ï¼‰
            if (profit < 0 && (stats.worstProfit === null || profit < stats.worstProfit)) {
                stats.worstProfit = profit;
                updated = true;
            }

            // æœ€å¤§é€£ãƒãƒ£ãƒ³
            if (stats.maxChain === null || maxChain > stats.maxChain) {
                stats.maxChain = maxChain;
                updated = true;
            }

            // ä¸€æ’ƒæœ€é«˜å‡ºç‰
            if (stats.maxPayout === null || totalPayout > stats.maxPayout) {
                stats.maxPayout = totalPayout;
                updated = true;
            }

            if (updated) {
                saveRankingStats(stats);
                updateRankingDisplay();
            }

            return updated;
        }

        function resetRankingStats() {
            if (confirm('å€‹äººè¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem(RANKING_KEY);
                updateRankingDisplay();
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚’æ›´æ–°
        document.addEventListener('DOMContentLoaded', updateRankingDisplay);

        // é›»ãƒãƒ¥ãƒ¼å‡ºç‰ã‚’å–å¾—ï¼ˆæŒ¯ã‚Šåˆ†ã‘ãŒã‚ã‚‹å ´åˆã¯ç¢ºç‡ã§é¸æŠï¼‰
        function getDenchuPayout(spec) {
            if (spec.denchuPayouts && spec.denchuPayouts.length > 0) {
                const r = Math.random();
                let cumulative = 0;
                for (const item of spec.denchuPayouts) {
                    cumulative += item.prob;
                    if (r < cumulative) {
                        return item.payout;
                    }
                }
                return spec.denchuPayouts[spec.denchuPayouts.length - 1].payout;
            }
            return spec.denchuPayout;
        }

        // UIæ›´æ–°
        function updateDisplay(rotations, balls, investment) {
            document.getElementById('rotationDisplay').textContent = rotations.toLocaleString();
            document.getElementById('ballsDisplay').textContent = Math.floor(balls).toLocaleString();
            document.getElementById('investDisplay').textContent = investment.toLocaleString();

            const profit = Math.floor(balls * 4) - investment;
            const profitEl = document.getElementById('profitDisplay');
            profitEl.textContent = (profit >= 0 ? '+' : '') + profit.toLocaleString();
            profitEl.className = 'stat-value ' + (profit >= 0 ? 'profit-plus' : 'profit-minus');
        }

        function setState(state, extra = '') {
            const el = document.getElementById('stateDisplay');
            let text = state;
            let className = 'state-normal';

            if (state === 'é€šå¸¸') {
                className = 'state-normal';
            } else if (state === 'ST' || state === 'LT') {
                className = 'state-st';
                text = `${state} ${extra}`;
            } else if (state === 'æ™‚çŸ­') {
                className = 'state-jitan';
                text = `æ™‚çŸ­ ${extra}`;
            }

            el.textContent = text;
            el.className = className;
        }

        function addLog(message, className = '') {
            const log = document.getElementById('log');
            const div = document.createElement('div');
            div.textContent = message;
            if (className) div.className = className;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getHesoResult(spec) {
            const r = Math.random();
            let cumulative = 0;
            for (const p of spec.hesoPayouts) {
                cumulative += p.prob;
                if (r < cumulative) {
                    return { payout: p.payout, st: p.st };
                }
            }
            const last = spec.hesoPayouts[spec.hesoPayouts.length - 1];
            return { payout: last.payout, st: last.st };
        }

        async function startSimulation() {
            if (isRunning) {
                shouldStop = true;
                return;
            }

            isRunning = true;
            shouldStop = false;

            const btn = document.getElementById('startBtn');
            btn.textContent = 'åœæ­¢';
            btn.style.background = 'linear-gradient(135deg, #666, #444)';

            const machineKey = document.getElementById('machine').value;
            const spec = SPECS[machineKey];
            const totalSpins = parseInt(document.getElementById('totalSpins').value);
            const rotation1k = parseInt(document.getElementById('rotation1k').value);
            const speedValue = parseInt(document.getElementById('speed').value);

            const ballsPer1k = 250;
            const ballsPerSpin = ballsPer1k / rotation1k;
            const ballsPerSpinJitan = ballsPer1k / spec.jitanRotation1k;

            // é€Ÿåº¦è¨­å®šï¼ˆå€¤ãŒå¤§ãã„ã»ã©é€Ÿã„ï¼‰
            const baseDelay = Math.max(5, 100 - speedValue * 10);

            clearLog();
            document.getElementById('finalResult').style.display = 'none';
            addLog(`ã€${spec.name}ã€‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹`);
            addLog(`æ¡ä»¶: 1k${rotation1k}å›è»¢ / ${totalSpins}å›è»¢`);
            addLog('â”€'.repeat(30));

            let rotations = 0;
            let myBalls = 0;
            let totalInvestment = 0;
            let hitCount = 0;
            let maxSessionChain = 0;  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®æœ€å¤§é€£ãƒãƒ£ãƒ³

            function consumeBalls(amount) {
                if (myBalls >= amount) {
                    myBalls -= amount;
                } else {
                    const shortage = amount - myBalls;
                    myBalls = 0;
                    const investUnits = Math.ceil(shortage / ballsPer1k);
                    totalInvestment += investUnits * 1000;
                    myBalls += investUnits * ballsPer1k - shortage;
                }
            }

            // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
            while (rotations < totalSpins && !shouldStop) {
                let spinsToHit = 0;
                let chargeBousou = false;

                // é€šå¸¸çŠ¶æ…‹
                setState('é€šå¸¸');
                while (rotations < totalSpins && !shouldStop) {
                    rotations++;
                    spinsToHit++;
                    consumeBalls(ballsPerSpin);

                    if (rotations % 10 === 0) {
                        updateDisplay(rotations, myBalls, totalInvestment);
                        await sleep(baseDelay / 5);
                    }

                    // ã‚¨ãƒ´ã‚¡ãƒãƒ£ãƒ¼ã‚¸
                    if (spec.chargeProb > 0 && Math.random() < spec.chargeProb) {
                        myBalls += spec.chargePayout;
                        addLog(`âš¡ ã‚¨ãƒ´ã‚¡ãƒãƒ£ãƒ¼ã‚¸ï¼ +${spec.chargePayout}ç™º`, 'log-charge');
                        if (Math.random() < spec.chargeStRate) {
                            chargeBousou = true;
                            addLog('ğŸ”¥ğŸ”¥ğŸ”¥ æš´èµ°ãƒ¢ãƒ¼ãƒ‰ï¼STçªå…¥ï¼ ğŸ”¥ğŸ”¥ğŸ”¥', 'log-charge');
                            await sleep(baseDelay * 5);
                            break;
                        }
                    }

                    // å½“ãŸã‚Šåˆ¤å®š
                    if (Math.random() < spec.hitProb) {
                        break;
                    }
                }

                if (shouldStop || rotations >= totalSpins) break;

                hitCount++;
                updateDisplay(rotations, myBalls, totalInvestment);

                // åˆå½“ãŸã‚Šå‡¦ç†
                let firstPayout, stEntered;
                if (chargeBousou) {
                    firstPayout = spec.chargePayout;
                    stEntered = true;
                    addLog(`ğŸ°ã€å½“ãŸã‚Š${hitCount}ã€‘æš´èµ°ã‹ã‚‰STçªå…¥ï¼`, 'log-hit');
                } else {
                    const result = getHesoResult(spec);
                    firstPayout = result.payout;
                    stEntered = result.st;
                    myBalls += firstPayout;
                    addLog(`ğŸ°ã€å½“ãŸã‚Š${hitCount}ã€‘${spinsToHit}å›è»¢ç›® +${firstPayout.toLocaleString()}ç™º`, 'log-hit');
                }

                await sleep(baseDelay * 3);

                if (stEntered) {
                    // ST/LTå‡¦ç†
                    const stLabel = spec.isLT ? 'LT' : 'ST';
                    const isLtChallenge = spec.ltChallengeRate > 0;
                    let chainCount = 1;
                    let chainPayout = firstPayout;

                    if (isLtChallenge) {
                        // LTãƒãƒ£ãƒ¬ãƒ³ã‚¸æ©Ÿç¨®ã®å ´åˆ
                        addLog(`>>> LTãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼`, 'log-st');
                        setState('LTãƒãƒ£ãƒ¬ãƒ³ã‚¸');
                        await sleep(baseDelay * 5);

                        // LTãƒãƒ£ãƒ¬ãƒ³ã‚¸åˆ¤å®š
                        if (Math.random() >= spec.ltChallengeRate) {
                            // LTãƒãƒ£ãƒ¬ãƒ³ã‚¸æ•—åŒ—
                            myBalls += spec.ltEndPayout;
                            chainPayout += spec.ltEndPayout;
                            updateDisplay(rotations, myBalls, totalInvestment);
                            addLog(`  LTãƒãƒ£ãƒ¬ãƒ³ã‚¸æ•—åŒ—... +${spec.ltEndPayout.toLocaleString()}ç™º`, 'log-chain');
                            await sleep(baseDelay * 3);
                            addLog(`çµ‚äº† â†’ 1é€£ è¨ˆ${chainPayout.toLocaleString()}ç™º`, 'log-st');
                        } else {
                            // LTãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸ â†’ LTçªå…¥
                            addLog(`ğŸ”¥ LTãƒãƒ£ãƒ¬ãƒ³ã‚¸æˆåŠŸï¼ LTçªå…¥ï¼`, 'log-st');
                            myBalls += spec.ltFirstPayout;
                            chainPayout += spec.ltFirstPayout;
                            chainCount++;
                            updateDisplay(rotations, myBalls, totalInvestment);
                            addLog(`  LTçªå…¥: +${spec.ltFirstPayout.toLocaleString()}ç™º`, 'log-chain');
                            await sleep(baseDelay * 4);
                            setState('LT');

                            // LTç¶™ç¶šãƒ«ãƒ¼ãƒ—
                            while (!shouldStop && Math.random() < spec.stContinueRate) {
                                chainCount++;
                                const payout = getDenchuPayout(spec);
                                myBalls += payout;
                                chainPayout += payout;
                                updateDisplay(rotations, myBalls, totalInvestment);
                                addLog(`  ${chainCount}é€£ç›®: LTç¶™ç¶š +${payout.toLocaleString()}ç™º`, 'log-chain');
                                await sleep(baseDelay * 4);
                            }

                            // LTè»¢è½
                            myBalls += spec.ltEndPayout;
                            chainPayout += spec.ltEndPayout;
                            updateDisplay(rotations, myBalls, totalInvestment);
                            addLog(`  LTè»¢è½ â†’ +${spec.ltEndPayout.toLocaleString()}ç™º`, 'log-chain');
                            await sleep(baseDelay * 2);
                            addLog(`LTçµ‚äº† â†’ ${chainCount}é€£ãƒãƒ£ãƒ³ï¼ è¨ˆ${chainPayout.toLocaleString()}ç™º`, 'log-st');
                            maxSessionChain = Math.max(maxSessionChain, chainCount);
                        }
                    } else {
                        // é€šå¸¸ST/LTæ©Ÿç¨®
                        const entryMsg = spec.isLT ? 'LTãƒãƒ£ãƒ¬ãƒ³ã‚¸' : 'STçªå…¥';
                        addLog(`>>> ${entryMsg}ï¼ï¼ˆ${spec.stSpins}å›è»¢ï¼‰`, 'log-st');
                        setState(stLabel, `${spec.stSpins}å›è»¢`);
                        await sleep(baseDelay * 5);

                        let stSpin = 1;
                        while (!shouldStop) {
                            if (spec.isLT) {
                                if (Math.random() >= spec.stContinueRate) break;
                                stSpin = 1;
                            } else {
                                let hitInSt = false;
                                for (stSpin = 1; stSpin <= spec.stSpins; stSpin++) {
                                    if (Math.random() < spec.stHitProb) {
                                        hitInSt = true;
                                        break;
                                    }
                                }
                                if (!hitInSt) break;
                            }

                            chainCount++;
                            const payout = getDenchuPayout(spec);
                            myBalls += payout;
                            chainPayout += payout;
                            updateDisplay(rotations, myBalls, totalInvestment);
                            const spinText = spec.isLT ? `${stLabel}1å›è»¢` : `ST${stSpin}å›è»¢`;
                            addLog(`  ${chainCount}é€£ç›®: ${spinText} +${payout.toLocaleString()}ç™º`, 'log-chain');
                            await sleep(baseDelay * 4);
                        }

                        // LTè»¢è½æ™‚å‡ºç‰
                        if (spec.ltEndPayout > 0) {
                            myBalls += spec.ltEndPayout;
                            chainPayout += spec.ltEndPayout;
                            updateDisplay(rotations, myBalls, totalInvestment);
                            addLog(`  LTè»¢è½ â†’ +${spec.ltEndPayout.toLocaleString()}ç™º`, 'log-chain');
                            await sleep(baseDelay * 2);
                        }

                        addLog(`${stLabel}çµ‚äº† â†’ ${chainCount}é€£ãƒãƒ£ãƒ³ï¼ è¨ˆ${chainPayout.toLocaleString()}ç™º`, 'log-st');
                        maxSessionChain = Math.max(maxSessionChain, chainCount);
                    }
                } else {
                    // æ™‚çŸ­å‡¦ç†
                    addLog(`â†’ å˜ç™ºçµ‚äº†ï¼ˆæ™‚çŸ­${spec.jitanSpins}å›è»¢ã¸ï¼‰`, 'log-jitan');
                    setState('æ™‚çŸ­', `0/${spec.jitanSpins}`);
                    await sleep(baseDelay * 2);

                    let jitanSpinCount = 0;
                    let hitInJitan = false;

                    while (jitanSpinCount < spec.jitanSpins && rotations < totalSpins && !shouldStop) {
                        rotations++;
                        jitanSpinCount++;
                        consumeBalls(ballsPerSpinJitan);

                        if (jitanSpinCount % 20 === 0) {
                            updateDisplay(rotations, myBalls, totalInvestment);
                            setState('æ™‚çŸ­', `${jitanSpinCount}/${spec.jitanSpins}`);
                            await sleep(baseDelay / 3);
                        }

                        if (Math.random() < spec.hitProb) {
                            hitInJitan = true;
                            break;
                        }
                    }

                    if (hitInJitan) {
                        // æ™‚çŸ­å¼•ãæˆ»ã—
                        hitCount++;
                        const payout = getDenchuPayout(spec);
                        myBalls += payout;
                        addLog(`ğŸ°ã€å½“ãŸã‚Š${hitCount}ã€‘æ™‚çŸ­${jitanSpinCount}å›è»¢ç›®ã§å¼•ãæˆ»ã—ï¼ +${payout.toLocaleString()}ç™º`, 'log-hit');
                        updateDisplay(rotations, myBalls, totalInvestment);
                        await sleep(baseDelay * 3);

                        // STçªå…¥
                        addLog(`>>> STçªå…¥ï¼ï¼ˆ${spec.stSpins}å›è»¢ï¼‰`, 'log-st');
                        setState('ST', `${spec.stSpins}å›è»¢`);
                        await sleep(baseDelay * 5);

                        let chainCount = 1;
                        let chainPayout = payout;

                        while (!shouldStop) {
                            let stSpin = 0;
                            let hitInSt = false;

                            for (stSpin = 1; stSpin <= spec.stSpins; stSpin++) {
                                if (Math.random() < spec.stHitProb) {
                                    hitInSt = true;
                                    break;
                                }
                            }

                            if (!hitInSt) break;

                            chainCount++;
                            const p = getDenchuPayout(spec);
                            myBalls += p;
                            chainPayout += p;
                            updateDisplay(rotations, myBalls, totalInvestment);
                            addLog(`  ${chainCount}é€£ç›®: ST${stSpin}å›è»¢ +${p.toLocaleString()}ç™º`, 'log-chain');
                            await sleep(baseDelay * 4);
                        }

                        addLog(`STçµ‚äº† â†’ ${chainCount}é€£ãƒãƒ£ãƒ³ï¼ è¨ˆ${chainPayout.toLocaleString()}ç™º`, 'log-st');
                        maxSessionChain = Math.max(maxSessionChain, chainCount);
                    } else {
                        // æ®‹ä¿ç•™ãƒã‚§ãƒƒã‚¯
                        if (spec.zanhoCount > 0) {
                            addLog(`æ™‚çŸ­çµ‚äº†... æ®‹ä¿ç•™ãƒã‚§ãƒƒã‚¯ï¼ˆ${spec.zanhoCount}å€‹ï¼‰`, 'log-jitan');
                            await sleep(baseDelay * 2);

                            let zanhoHit = false;
                            for (let i = 0; i < spec.zanhoCount; i++) {
                                if (Math.random() < spec.hitProb) {
                                    zanhoHit = true;
                                    hitCount++;
                                    const payout = getDenchuPayout(spec);
                                    myBalls += payout;
                                    addLog(`âœ¨ æ®‹ä¿ç•™${i + 1}å€‹ç›®ã§å½“ãŸã‚Šï¼ +${payout.toLocaleString()}ç™º`, 'log-hit');
                                    updateDisplay(rotations, myBalls, totalInvestment);

                                    // STå‡¦ç†
                                    addLog(`>>> STçªå…¥ï¼ï¼ˆ${spec.stSpins}å›è»¢ï¼‰`, 'log-st');
                                    setState('ST', `${spec.stSpins}å›è»¢`);
                                    await sleep(baseDelay * 5);

                                    let chainCount = 1;
                                    let chainPayout = payout;

                                    while (!shouldStop) {
                                        let stSpin = 0;
                                        let hitInSt = false;

                                        for (stSpin = 1; stSpin <= spec.stSpins; stSpin++) {
                                            if (Math.random() < spec.stHitProb) {
                                                hitInSt = true;
                                                break;
                                            }
                                        }

                                        if (!hitInSt) break;

                                        chainCount++;
                                        const p = getDenchuPayout(spec);
                                        myBalls += p;
                                        chainPayout += p;
                                        updateDisplay(rotations, myBalls, totalInvestment);
                                        addLog(`  ${chainCount}é€£ç›®: ST${stSpin}å›è»¢ +${p.toLocaleString()}ç™º`, 'log-chain');
                                        await sleep(baseDelay * 4);
                                    }

                                    addLog(`STçµ‚äº† â†’ ${chainCount}é€£ãƒãƒ£ãƒ³ï¼ è¨ˆ${chainPayout.toLocaleString()}ç™º`, 'log-st');
                                    maxSessionChain = Math.max(maxSessionChain, chainCount);
                                    break;
                                }
                            }

                            if (!zanhoHit) {
                                addLog(`â†’ é€šå¸¸çŠ¶æ…‹ã¸`, 'log-jitan');
                            }
                        } else {
                            addLog(`æ™‚çŸ­çµ‚äº† â†’ é€šå¸¸çŠ¶æ…‹ã¸`, 'log-jitan');
                        }
                    }
                }

                await sleep(baseDelay * 2);
            }

            // æœ€çµ‚çµæœ
            updateDisplay(rotations, myBalls, totalInvestment);
            const finalProfit = Math.floor(myBalls * 4) - totalInvestment;

            addLog('â”€'.repeat(30));
            addLog(`ã€æœ€çµ‚çµæœã€‘`);
            addLog(`ç·å›è»¢æ•°: ${rotations.toLocaleString()}å›è»¢`);
            addLog(`ç·å½“ãŸã‚Š: ${hitCount}å›`);
            addLog(`æŒã¡ç‰: ${Math.floor(myBalls).toLocaleString()}ç™º`);
            addLog(`åæ”¯: ${(finalProfit >= 0 ? '+' : '')}${finalProfit.toLocaleString()}å††`);

            // çµæœè¡¨ç¤º
            document.getElementById('finalSpins').textContent = rotations.toLocaleString();
            document.getElementById('finalHits').textContent = hitCount;
            document.getElementById('finalBalls').textContent = Math.floor(myBalls).toLocaleString();
            const finalProfitEl = document.getElementById('finalProfit');
            finalProfitEl.textContent = (finalProfit >= 0 ? '+' : '') + finalProfit.toLocaleString() + 'å††';
            finalProfitEl.className = 'final-stat-value ' + (finalProfit >= 0 ? 'profit-plus' : 'profit-minus');
            document.getElementById('finalResult').style.display = 'block';

            // ç´¯è¨ˆåæ”¯ã«è¿½åŠ 
            addSessionResult(totalInvestment, Math.floor(myBalls));

            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
            updateRankingWithResult(finalProfit, maxSessionChain, Math.floor(myBalls));

            setState('çµ‚äº†');
            btn.textContent = 'ã‚‚ã†ä¸€åº¦';
            btn.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a5a)';
            isRunning = false;
        }

        // é€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        document.getElementById('speed').addEventListener('input', (e) => {
            document.getElementById('speedLabel').textContent = e.target.value;
        });
    </script>
</body>
</html>
