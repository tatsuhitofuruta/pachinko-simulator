<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¨ãƒ´ã‚¡ ãƒ‘ãƒãƒ³ã‚³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Hiragino Kaku Gothic ProN', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #ff6b6b;
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }
        .controls {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .control-group {
            flex: 1;
            min-width: 120px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #aaa;
            font-size: 14px;
        }
        select, input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255,255,255,0.15);
            color: #fff;
            font-size: 16px;
        }
        select option {
            background: #1a1a2e;
        }
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-start {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }
        .btn-start:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }
        .btn-start:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        .display {
            background: #000;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status-line {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #0f0;
            margin-bottom: 10px;
        }
        .rotation-display {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            color: #fff;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
        }
        .rotation-label {
            text-align: center;
            color: #888;
            margin-top: 5px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .stat-box {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
        }
        .profit-plus { color: #4ecdc4; }
        .profit-minus { color: #ff6b6b; }
        .log {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .log-hit {
            color: #ffd93d;
            font-weight: bold;
        }
        .log-st {
            color: #ff6b6b;
        }
        .log-chain {
            color: #4ecdc4;
            padding-left: 20px;
        }
        .log-jitan {
            color: #a855f7;
        }
        .log-charge {
            color: #f59e0b;
        }
        .state-normal { color: #4ecdc4; }
        .state-st { color: #ff6b6b; }
        .state-jitan { color: #a855f7; }
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .speed-control input[type="range"] {
            flex: 1;
        }
        .final-result {
            background: linear-gradient(135deg, #2d2d44, #1a1a2e);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            display: none;
        }
        .final-result h2 {
            color: #ff6b6b;
            margin-bottom: 20px;
        }
        .final-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .final-stat {
            padding: 10px;
        }
        .final-stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        .final-stat-label {
            color: #888;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ° ã‚¨ãƒ´ã‚¡ ãƒ‘ãƒãƒ³ã‚³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h1>
        <p class="subtitle">ãƒªã‚¢ãƒ«ãƒ—ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰</p>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label>æ©Ÿç¨®</label>
                    <select id="machine">
                        <option value="eva15">ã‚¨ãƒ´ã‚¡15ï¼ˆæœªæ¥ã¸ã®å’†å“®ï¼‰</option>
                        <option value="eva17">ã‚¨ãƒ´ã‚¡17ï¼ˆã¯ã˜ã¾ã‚Šã®è¨˜æ†¶ï¼‰</option>
                        <option value="garo12">ç‰™ç‹¼12ï¼ˆé»„é‡‘é¨å£«æ¥µé™ï¼‰</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>ç·å›è»¢æ•°</label>
                    <select id="totalSpins">
                        <option value="500">500å›è»¢</option>
                        <option value="1000">1000å›è»¢</option>
                        <option value="2000" selected>2000å›è»¢</option>
                        <option value="3000">3000å›è»¢</option>
                    </select>
                </div>
            </div>
            <div class="control-row">
                <div class="control-group">
                    <label>åƒå††å›è»¢æ•°</label>
                    <select id="rotation1k">
                        <option value="16">16å›è»¢</option>
                        <option value="17">17å›è»¢</option>
                        <option value="18" selected>18å›è»¢</option>
                        <option value="19">19å›è»¢</option>
                        <option value="20">20å›è»¢</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>é€Ÿåº¦</label>
                    <div class="speed-control">
                        <input type="range" id="speed" min="1" max="10" value="5">
                        <span id="speedLabel">5</span>
                    </div>
                </div>
            </div>
            <button class="btn btn-start" id="startBtn" onclick="startSimulation()">
                ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            </button>
        </div>

        <div class="display">
            <div class="rotation-display" id="rotationDisplay">0</div>
            <div class="rotation-label">å›è»¢</div>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="ballsDisplay">0</div>
                    <div class="stat-label">æŒã¡ç‰</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="investDisplay">0</div>
                    <div class="stat-label">æŠ•è³‡(å††)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value profit-minus" id="profitDisplay">0</div>
                    <div class="stat-label">åæ”¯(å††)</div>
                </div>
            </div>
            <div class="status-line">
                çŠ¶æ…‹: <span id="stateDisplay" class="state-normal">å¾…æ©Ÿä¸­</span>
            </div>
        </div>

        <div class="log" id="log"></div>

        <div class="final-result" id="finalResult">
            <h2>ğŸ° æœ€çµ‚çµæœ</h2>
            <div class="final-stats">
                <div class="final-stat">
                    <div class="final-stat-value" id="finalSpins">0</div>
                    <div class="final-stat-label">ç·å›è»¢æ•°</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalHits">0</div>
                    <div class="final-stat-label">ç·å½“ãŸã‚Š</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalBalls">0</div>
                    <div class="final-stat-label">æŒã¡ç‰</div>
                </div>
                <div class="final-stat">
                    <div class="final-stat-value" id="finalProfit">0</div>
                    <div class="final-stat-label">åæ”¯</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ©Ÿç¨®ã‚¹ãƒšãƒƒã‚¯
        const SPECS = {
            eva15: {
                name: "ã‚¨ãƒ´ã‚¡15ï¼ˆæœªæ¥ã¸ã®å’†å“®ï¼‰",
                hitProb: 1 / 319.7,
                stHitProb: 1 / 99.4,
                hesoPayouts: [
                    { prob: 0.03, payout: 1400, st: true },
                    { prob: 0.56, payout: 420, st: true },
                    { prob: 0.41, payout: 420, st: false }
                ],
                denchuPayout: 1400,
                stSpins: 163,
                jitanSpins: 100,
                jitanRotation1k: 30,
                zanhoCount: 4,
                chargeProb: 0,
                chargePayout: 0,
                chargeStRate: 0,
                isLT: false,
                ltEndPayout: 0,
                stContinueRate: 0.807
            },
            eva17: {
                name: "ã‚¨ãƒ´ã‚¡17ï¼ˆã¯ã˜ã¾ã‚Šã®è¨˜æ†¶ï¼‰",
                hitProb: 1 / 399.9,
                stHitProb: 1 / 99.6,
                hesoPayouts: [
                    { prob: 0.005, payout: 1400, st: true },
                    { prob: 0.495, payout: 280, st: false },
                    { prob: 0.50, payout: 280, st: true }
                ],
                denchuPayout: 2240,
                stSpins: 157,
                jitanSpins: 100,
                jitanRotation1k: 30,
                zanhoCount: 0,
                chargeProb: 1 / 2750.9,
                chargePayout: 280,
                chargeStRate: 0.02,
                isLT: false,
                ltEndPayout: 0,
                stContinueRate: 0.795
            },
            garo12: {
                name: "ç‰™ç‹¼12ï¼ˆé»„é‡‘é¨å£«æ¥µé™ï¼‰",
                hitProb: 1 / 437.49,
                stHitProb: 1.0,
                hesoPayouts: [
                    { prob: 0.50, payout: 1400, st: true },
                    { prob: 0.50, payout: 1400, st: false }
                ],
                denchuPayout: 7000,
                stSpins: 1,
                jitanSpins: 0,
                jitanRotation1k: 30,
                zanhoCount: 0,
                chargeProb: 0,
                chargePayout: 0,
                chargeStRate: 0,
                isLT: true,
                ltEndPayout: 1400,
                stContinueRate: 0.50
            }
        };

        let isRunning = false;
        let shouldStop = false;

        // UIæ›´æ–°
        function updateDisplay(rotations, balls, investment) {
            document.getElementById('rotationDisplay').textContent = rotations.toLocaleString();
            document.getElementById('ballsDisplay').textContent = Math.floor(balls).toLocaleString();
            document.getElementById('investDisplay').textContent = investment.toLocaleString();

            const profit = Math.floor(balls * 4) - investment;
            const profitEl = document.getElementById('profitDisplay');
            profitEl.textContent = (profit >= 0 ? '+' : '') + profit.toLocaleString();
            profitEl.className = 'stat-value ' + (profit >= 0 ? 'profit-plus' : 'profit-minus');
        }

        function setState(state, extra = '') {
            const el = document.getElementById('stateDisplay');
            let text = state;
            let className = 'state-normal';

            if (state === 'é€šå¸¸') {
                className = 'state-normal';
            } else if (state === 'ST' || state === 'LT') {
                className = 'state-st';
                text = `${state} ${extra}`;
            } else if (state === 'æ™‚çŸ­') {
                className = 'state-jitan';
                text = `æ™‚çŸ­ ${extra}`;
            }

            el.textContent = text;
            el.className = className;
        }

        function addLog(message, className = '') {
            const log = document.getElementById('log');
            const div = document.createElement('div');
            div.textContent = message;
            if (className) div.className = className;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function getHesoResult(spec) {
            const r = Math.random();
            let cumulative = 0;
            for (const p of spec.hesoPayouts) {
                cumulative += p.prob;
                if (r < cumulative) {
                    return { payout: p.payout, st: p.st };
                }
            }
            const last = spec.hesoPayouts[spec.hesoPayouts.length - 1];
            return { payout: last.payout, st: last.st };
        }

        async function startSimulation() {
            if (isRunning) {
                shouldStop = true;
                return;
            }

            isRunning = true;
            shouldStop = false;

            const btn = document.getElementById('startBtn');
            btn.textContent = 'åœæ­¢';
            btn.style.background = 'linear-gradient(135deg, #666, #444)';

            const machineKey = document.getElementById('machine').value;
            const spec = SPECS[machineKey];
            const totalSpins = parseInt(document.getElementById('totalSpins').value);
            const rotation1k = parseInt(document.getElementById('rotation1k').value);
            const speedValue = parseInt(document.getElementById('speed').value);

            const ballsPer1k = 250;
            const ballsPerSpin = ballsPer1k / rotation1k;
            const ballsPerSpinJitan = ballsPer1k / spec.jitanRotation1k;

            // é€Ÿåº¦è¨­å®šï¼ˆå€¤ãŒå¤§ãã„ã»ã©é€Ÿã„ï¼‰
            const baseDelay = Math.max(5, 100 - speedValue * 10);

            clearLog();
            document.getElementById('finalResult').style.display = 'none';
            addLog(`ã€${spec.name}ã€‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹`);
            addLog(`æ¡ä»¶: 1k${rotation1k}å›è»¢ / ${totalSpins}å›è»¢`);
            addLog('â”€'.repeat(30));

            let rotations = 0;
            let myBalls = 0;
            let totalInvestment = 0;
            let hitCount = 0;

            function consumeBalls(amount) {
                if (myBalls >= amount) {
                    myBalls -= amount;
                } else {
                    const shortage = amount - myBalls;
                    myBalls = 0;
                    const investUnits = Math.ceil(shortage / ballsPer1k);
                    totalInvestment += investUnits * 1000;
                    myBalls += investUnits * ballsPer1k - shortage;
                }
            }

            // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
            while (rotations < totalSpins && !shouldStop) {
                let spinsToHit = 0;
                let chargeBousou = false;

                // é€šå¸¸çŠ¶æ…‹
                setState('é€šå¸¸');
                while (rotations < totalSpins && !shouldStop) {
                    rotations++;
                    spinsToHit++;
                    consumeBalls(ballsPerSpin);

                    if (rotations % 10 === 0) {
                        updateDisplay(rotations, myBalls, totalInvestment);
                        await sleep(baseDelay / 5);
                    }

                    // ã‚¨ãƒ´ã‚¡ãƒãƒ£ãƒ¼ã‚¸
                    if (spec.chargeProb > 0 && Math.random() < spec.chargeProb) {
                        myBalls += spec.chargePayout;
                        addLog(`âš¡ ã‚¨ãƒ´ã‚¡ãƒãƒ£ãƒ¼ã‚¸ï¼ +${spec.chargePayout}ç™º`, 'log-charge');
                        if (Math.random() < spec.chargeStRate) {
                            chargeBousou = true;
                            addLog('ğŸ”¥ğŸ”¥ğŸ”¥ æš´èµ°ãƒ¢ãƒ¼ãƒ‰ï¼STçªå…¥ï¼ ğŸ”¥ğŸ”¥ğŸ”¥', 'log-charge');
                            await sleep(baseDelay * 5);
                            break;
                        }
                    }

                    // å½“ãŸã‚Šåˆ¤å®š
                    if (Math.random() < spec.hitProb) {
                        break;
                    }
                }

                if (shouldStop || rotations >= totalSpins) break;

                hitCount++;
                updateDisplay(rotations, myBalls, totalInvestment);

                // åˆå½“ãŸã‚Šå‡¦ç†
                let firstPayout, stEntered;
                if (chargeBousou) {
                    firstPayout = spec.chargePayout;
                    stEntered = true;
                    addLog(`ğŸ°ã€å½“ãŸã‚Š${hitCount}ã€‘æš´èµ°ã‹ã‚‰STçªå…¥ï¼`, 'log-hit');
                } else {
                    const result = getHesoResult(spec);
                    firstPayout = result.payout;
                    stEntered = result.st;
                    myBalls += firstPayout;
                    addLog(`ğŸ°ã€å½“ãŸã‚Š${hitCount}ã€‘${spinsToHit}å›è»¢ç›® +${firstPayout.toLocaleString()}ç™º`, 'log-hit');
                }

                await sleep(baseDelay * 3);

                if (stEntered) {
                    // ST/LTå‡¦ç†
                    const stLabel = spec.isLT ? 'LT' : 'ST';
                    const entryMsg = spec.isLT ? 'LTãƒãƒ£ãƒ¬ãƒ³ã‚¸' : 'STçªå…¥';
                    addLog(`>>> ${entryMsg}ï¼ï¼ˆ${spec.stSpins}å›è»¢ï¼‰`, 'log-st');
                    setState(stLabel, `${spec.stSpins}å›è»¢`);
                    await sleep(baseDelay * 5);

                    let chainCount = 1;
                    let chainPayout = firstPayout;

                    let stSpin = 1;  // ãƒ«ãƒ¼ãƒ—å¤–ã§å®£è¨€
                    while (!shouldStop) {
                        if (spec.isLT) {
                            // LTæ©Ÿç¨®: st_continue_rateã§ç¶™ç¶šåˆ¤å®š
                            if (Math.random() >= spec.stContinueRate) break;
                            stSpin = 1;
                        } else {
                            // STæ©Ÿç¨®: å®Ÿéš›ã«STå›è»¢ã‚’æ¶ˆåŒ–ã—ã¦å½“ãŸã‚Šã‚’å¼•ã
                            let hitInSt = false;
                            for (stSpin = 1; stSpin <= spec.stSpins; stSpin++) {
                                if (Math.random() < spec.stHitProb) {
                                    hitInSt = true;
                                    break;
                                }
                            }
                            if (!hitInSt) break;
                        }

                        chainCount++;
                        const payout = spec.denchuPayout;
                        myBalls += payout;
                        chainPayout += payout;
                        updateDisplay(rotations, myBalls, totalInvestment);
                        const spinText = spec.isLT ? `${stLabel}1å›è»¢` : `ST${stSpin}å›è»¢`;
                        addLog(`  ${chainCount}é€£ç›®: ${spinText} +${payout.toLocaleString()}ç™º`, 'log-chain');
                        await sleep(baseDelay * 4);
                    }

                    // LTè»¢è½æ™‚å‡ºç‰
                    if (spec.ltEndPayout > 0) {
                        myBalls += spec.ltEndPayout;
                        chainPayout += spec.ltEndPayout;
                        updateDisplay(rotations, myBalls, totalInvestment);
                        addLog(`  LTè»¢è½ â†’ +${spec.ltEndPayout.toLocaleString()}ç™º`, 'log-chain');
                        await sleep(baseDelay * 2);
                    }

                    addLog(`${stLabel}çµ‚äº† â†’ ${chainCount}é€£ãƒãƒ£ãƒ³ï¼ è¨ˆ${chainPayout.toLocaleString()}ç™º`, 'log-st');
                } else {
                    // æ™‚çŸ­å‡¦ç†
                    addLog(`â†’ å˜ç™ºçµ‚äº†ï¼ˆæ™‚çŸ­${spec.jitanSpins}å›è»¢ã¸ï¼‰`, 'log-jitan');
                    setState('æ™‚çŸ­', `0/${spec.jitanSpins}`);
                    await sleep(baseDelay * 2);

                    let jitanSpinCount = 0;
                    let hitInJitan = false;

                    while (jitanSpinCount < spec.jitanSpins && rotations < totalSpins && !shouldStop) {
                        rotations++;
                        jitanSpinCount++;
                        consumeBalls(ballsPerSpinJitan);

                        if (jitanSpinCount % 20 === 0) {
                            updateDisplay(rotations, myBalls, totalInvestment);
                            setState('æ™‚çŸ­', `${jitanSpinCount}/${spec.jitanSpins}`);
                            await sleep(baseDelay / 3);
                        }

                        if (Math.random() < spec.hitProb) {
                            hitInJitan = true;
                            break;
                        }
                    }

                    if (hitInJitan) {
                        // æ™‚çŸ­å¼•ãæˆ»ã—
                        hitCount++;
                        const payout = spec.denchuPayout;
                        myBalls += payout;
                        addLog(`ğŸ°ã€å½“ãŸã‚Š${hitCount}ã€‘æ™‚çŸ­${jitanSpinCount}å›è»¢ç›®ã§å¼•ãæˆ»ã—ï¼ +${payout.toLocaleString()}ç™º`, 'log-hit');
                        updateDisplay(rotations, myBalls, totalInvestment);
                        await sleep(baseDelay * 3);

                        // STçªå…¥
                        addLog(`>>> STçªå…¥ï¼ï¼ˆ${spec.stSpins}å›è»¢ï¼‰`, 'log-st');
                        setState('ST', `${spec.stSpins}å›è»¢`);
                        await sleep(baseDelay * 5);

                        let chainCount = 1;
                        let chainPayout = payout;

                        while (!shouldStop) {
                            let stSpin = 0;
                            let hitInSt = false;

                            for (stSpin = 1; stSpin <= spec.stSpins; stSpin++) {
                                if (Math.random() < spec.stHitProb) {
                                    hitInSt = true;
                                    break;
                                }
                            }

                            if (!hitInSt) break;

                            chainCount++;
                            const p = spec.denchuPayout;
                            myBalls += p;
                            chainPayout += p;
                            updateDisplay(rotations, myBalls, totalInvestment);
                            addLog(`  ${chainCount}é€£ç›®: ST${stSpin}å›è»¢ +${p.toLocaleString()}ç™º`, 'log-chain');
                            await sleep(baseDelay * 4);
                        }

                        addLog(`STçµ‚äº† â†’ ${chainCount}é€£ãƒãƒ£ãƒ³ï¼ è¨ˆ${chainPayout.toLocaleString()}ç™º`, 'log-st');
                    } else {
                        // æ®‹ä¿ç•™ãƒã‚§ãƒƒã‚¯
                        if (spec.zanhoCount > 0) {
                            addLog(`æ™‚çŸ­çµ‚äº†... æ®‹ä¿ç•™ãƒã‚§ãƒƒã‚¯ï¼ˆ${spec.zanhoCount}å€‹ï¼‰`, 'log-jitan');
                            await sleep(baseDelay * 2);

                            let zanhoHit = false;
                            for (let i = 0; i < spec.zanhoCount; i++) {
                                if (Math.random() < spec.hitProb) {
                                    zanhoHit = true;
                                    hitCount++;
                                    const payout = spec.denchuPayout;
                                    myBalls += payout;
                                    addLog(`âœ¨ æ®‹ä¿ç•™${i + 1}å€‹ç›®ã§å½“ãŸã‚Šï¼ +${payout.toLocaleString()}ç™º`, 'log-hit');
                                    updateDisplay(rotations, myBalls, totalInvestment);

                                    // STå‡¦ç†
                                    addLog(`>>> STçªå…¥ï¼ï¼ˆ${spec.stSpins}å›è»¢ï¼‰`, 'log-st');
                                    setState('ST', `${spec.stSpins}å›è»¢`);
                                    await sleep(baseDelay * 5);

                                    let chainCount = 1;
                                    let chainPayout = payout;

                                    while (!shouldStop) {
                                        let stSpin = 0;
                                        let hitInSt = false;

                                        for (stSpin = 1; stSpin <= spec.stSpins; stSpin++) {
                                            if (Math.random() < spec.stHitProb) {
                                                hitInSt = true;
                                                break;
                                            }
                                        }

                                        if (!hitInSt) break;

                                        chainCount++;
                                        const p = spec.denchuPayout;
                                        myBalls += p;
                                        chainPayout += p;
                                        updateDisplay(rotations, myBalls, totalInvestment);
                                        addLog(`  ${chainCount}é€£ç›®: ST${stSpin}å›è»¢ +${p.toLocaleString()}ç™º`, 'log-chain');
                                        await sleep(baseDelay * 4);
                                    }

                                    addLog(`STçµ‚äº† â†’ ${chainCount}é€£ãƒãƒ£ãƒ³ï¼ è¨ˆ${chainPayout.toLocaleString()}ç™º`, 'log-st');
                                    break;
                                }
                            }

                            if (!zanhoHit) {
                                addLog(`â†’ é€šå¸¸çŠ¶æ…‹ã¸`, 'log-jitan');
                            }
                        } else {
                            addLog(`æ™‚çŸ­çµ‚äº† â†’ é€šå¸¸çŠ¶æ…‹ã¸`, 'log-jitan');
                        }
                    }
                }

                await sleep(baseDelay * 2);
            }

            // æœ€çµ‚çµæœ
            updateDisplay(rotations, myBalls, totalInvestment);
            const finalProfit = Math.floor(myBalls * 4) - totalInvestment;

            addLog('â”€'.repeat(30));
            addLog(`ã€æœ€çµ‚çµæœã€‘`);
            addLog(`ç·å›è»¢æ•°: ${rotations.toLocaleString()}å›è»¢`);
            addLog(`ç·å½“ãŸã‚Š: ${hitCount}å›`);
            addLog(`æŒã¡ç‰: ${Math.floor(myBalls).toLocaleString()}ç™º`);
            addLog(`åæ”¯: ${(finalProfit >= 0 ? '+' : '')}${finalProfit.toLocaleString()}å††`);

            // çµæœè¡¨ç¤º
            document.getElementById('finalSpins').textContent = rotations.toLocaleString();
            document.getElementById('finalHits').textContent = hitCount;
            document.getElementById('finalBalls').textContent = Math.floor(myBalls).toLocaleString();
            const finalProfitEl = document.getElementById('finalProfit');
            finalProfitEl.textContent = (finalProfit >= 0 ? '+' : '') + finalProfit.toLocaleString() + 'å††';
            finalProfitEl.className = 'final-stat-value ' + (finalProfit >= 0 ? 'profit-plus' : 'profit-minus');
            document.getElementById('finalResult').style.display = 'block';

            setState('çµ‚äº†');
            btn.textContent = 'ã‚‚ã†ä¸€åº¦';
            btn.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a5a)';
            isRunning = false;
        }

        // é€Ÿåº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
        document.getElementById('speed').addEventListener('input', (e) => {
            document.getElementById('speedLabel').textContent = e.target.value;
        });
    </script>
</body>
</html>
